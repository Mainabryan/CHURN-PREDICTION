# -*- coding: utf-8 -*-
"""churn streamlit

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1njgS-goneTMD9INPbCL3-zV0kBVcZ_Vj
"""

import streamlit as st
import pickle
import pandas as pd
import plotly.express as px

# -----------------------------
# PAGE CONFIG
# -----------------------------
st.set_page_config(
    page_title="Customer Churn Prediction",
    layout="wide"
)

# -----------------------------
# LOAD MODEL & SCALER
# -----------------------------
with open("/content/best_model(1).pkl", "rb") as f:
    model = pickle.load(f)

with open("scaler.pkl", "rb") as f:
    scaler = pickle.load(f)

# -----------------------------
# FEATURE NAMES (MUST MATCH TRAINING)
# -----------------------------
FEATURE_NAMES = [
    'CreditScore', 'Age', 'Tenure', 'Balance', 'NumOfProducts',
    'EstimatedSalary',
    'Geography_France', 'Geography_Germany', 'Geography_Spain',
    'Gender_Female', 'Gender_Male',
    'HasCrCard_0', 'HasCrCard_1',
    'IsActiveMember_0', 'IsActiveMember_1'
]

SCALE_VARS = [
    'CreditScore', 'Age', 'Tenure',
    'Balance', 'NumOfProducts', 'EstimatedSalary'
]

# -----------------------------
# SIDEBAR â€“ USER INPUTS
# -----------------------------
st.sidebar.image("openart-image.png", use_column_width=True)
st.sidebar.header("Customer Information")

credit_score = st.sidebar.slider("Credit Score", 350, 850, 600)
age = st.sidebar.slider("Age", 18, 92, 30)
tenure = st.sidebar.slider("Tenure (Years)", 0, 10, 2)
balance = st.sidebar.slider("Balance", 0.0, 250000.0, 60000.0)
num_products = st.sidebar.slider("Number of Products", 1, 4, 1)
salary = st.sidebar.slider("Estimated Salary", 0.0, 200000.0, 50000.0)

geography = st.sidebar.selectbox("Geography", ["France", "Germany", "Spain"])
gender = st.sidebar.selectbox("Gender", ["Female", "Male"])
has_card = st.sidebar.selectbox("Has Credit Card", [0, 1])
is_active = st.sidebar.selectbox("Is Active Member", [0, 1])

# -----------------------------
# ONE-HOT ENCODING (MANUAL)
# -----------------------------
geo_fr = 1 if geography == "France" else 0
geo_ge = 1 if geography == "Germany" else 0
geo_sp = 1 if geography == "Spain" else 0

gen_f = 1 if gender == "Female" else 0
gen_m = 1 if gender == "Male" else 0

card_0 = 1 if has_card == 0 else 0
card_1 = 1 if has_card == 1 else 0

active_0 = 1 if is_active == 0 else 0
active_1 = 1 if is_active == 1 else 0

# -----------------------------
# INPUT DATAFRAME
# -----------------------------
input_data = pd.DataFrame([{
    'CreditScore': credit_score,
    'Age': age,
    'Tenure': tenure,
    'Balance': balance,
    'NumOfProducts': num_products,
    'EstimatedSalary': salary,
    'Geography_France': geo_fr,
    'Geography_Germany': geo_ge,
    'Geography_Spain': geo_sp,
    'Gender_Female': gen_f,
    'Gender_Male': gen_m,
    'HasCrCard_0': card_0,
    'HasCrCard_1': card_1,
    'IsActiveMember_0': active_0,
    'IsActiveMember_1': active_1
}])

# Ensure correct column order
input_data = input_data[FEATURE_NAMES]

# Scale numerical columns
input_data[SCALE_VARS] = scaler.transform(input_data[SCALE_VARS])

# -----------------------------
# MAIN PAGE
# -----------------------------
st.image("openart-image.png", use_column_width=True)
st.title("Customer Churn Prediction")

left_col, right_col = st.columns(2)

# -----------------------------
# LEFT COLUMN â€“ FEATURE IMPORTANCE
# -----------------------------
with left_col:
    st.subheader("Feature Importance")
    feature_importance = pd.read_excel("feature_importance.xlsx")

    fig = px.bar(
        feature_importance.sort_values("Importance", ascending=False),
        x="Importance",
        y="Feature",
        orientation="h"
    )
    st.plotly_chart(fig, use_container_width=True)

# -----------------------------
# RIGHT COLUMN â€“ PREDICTION
# -----------------------------
with right_col:
    st.subheader("Prediction Result")

    if st.button("Predict Churn"):
        prediction = model.predict(input_data)[0]
        prob = model.predict_proba(input_data)[0][1]

        if prediction == 1:
            st.error("ðŸš¨ Customer is likely to CHURN")
        else:
            st.success("âœ… Customer is likely to STAY")

        st.write(f"**Churn Probability:** {prob:.2f}")
        st.write(f"**Retention Probability:** {1 - prob:.2f}")